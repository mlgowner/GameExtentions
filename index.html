<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
    let isAuthenticated = !!sessionStorage.getItem('authToken');

    function showMessage(text, isError = false) {
        const msgEl = document.getElementById('message');
        msgEl.textContent = text;
        msgEl.classList.remove('hidden');
        msgEl.style.color = isError ? '#ff4444' : '#44ff44';
        setTimeout(() => msgEl.classList.add('hidden'), 3000);
        console.log(`Сообщение: ${text} (Ошибка: ${isError})`);
    }

    function showProfile() {
        document.getElementById('authForm').classList.add('hidden');
        document.getElementById('profileContent').classList.remove('hidden');
        document.getElementById('modButtons').style.display = 'block';
    }

    function showAuth() {
        document.getElementById('authForm').classList.remove('hidden');
        document.getElementById('profileContent').classList.add('hidden');
        document.getElementById('modButtons').style.display = 'none';
        document.getElementById('stats').innerHTML = '';
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email.toLowerCase());
    }

    // Single web_app_data listener
    tg.onEvent('web_app_data', (data) => {
        console.log("Ответ от бота:", data.data);
        try {
            const response = JSON.parse(data.data);
            if (response.status === "success") {
                if (["login", "check_auth"].includes(response.action)) {
                    sessionStorage.setItem('authToken', 'true');
                    isAuthenticated = true;
                    showProfile();
                    document.getElementById('stats').innerHTML = response.message;
                    showMessage(response.action === "login" ? "Успешный вход!" : "Автоматический вход выполнен!");
                } else if (response.action === "register") {
                    showMessage("Регистрация прошла! Теперь войдите.");
                } else if (response.action === "stats") {
                    document.getElementById('stats').innerHTML = response.message;
                    showMessage("Статистика обновлена!");
                } else if (response.action === "download") {
                    showMessage("Мод скачан!");
                }
            } else {
                showMessage(`Ошибка: ${response.message}`, true);
            }
        } catch (e) {
            showMessage("Ошибка обработки ответа от бота!", true);
            console.error("Ошибка парсинга ответа:", e);
        }
    });

    function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!userId) {
            showMessage("Ошибка: не удалось получить Telegram ID!", true);
            return;
        }
        if (!email || !password) {
            showMessage("Введите email и пароль!", true);
            return;
        }
        const passwordHash = sha256(password);
        console.log(`Попытка входа: userId=${userId}, email=${email}`);
        tg.sendData(JSON.stringify({ action: "login", user_id: userId, email, password_hash: passwordHash }));
    }

    function register() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!userId) {
            showMessage("Ошибка: не удалось получить Telegram ID!", true);
            return;
        }
        if (!email || !password) {
            showMessage("Введите email и пароль!", true);
            return;
        }
        if (!validateEmail(email)) {
            showMessage("Некорректный email! Используйте формат example@domain.com", true);
            return;
        }
        const passwordHash = sha256(password);
        console.log(`Попытка регистрации: userId=${userId}, email=${email}`);
        tg.sendData(JSON.stringify({ action: "register", user_id: userId, email, password_hash: passwordHash }));
    }

    function logout() {
        sessionStorage.removeItem('authToken');
        isAuthenticated = false;
        showAuth();
        showMessage("Выход выполнен!");
    }

    function refreshStats() {
        if (!userId) {
            showMessage("Ошибка: нет Telegram ID!", true);
            return;
        }
        console.log(`Обновление статистики для userId=${userId}`);
        tg.sendData(JSON.stringify({ action: "stats", user_id: userId }));
    }

    function downloadMod(modName) {
        if (!isAuthenticated) {
            showMessage("Сначала войдите в аккаунт!", true);
            return;
        }
        console.log(`Скачивание мода ${modName} для userId=${userId}`);
        tg.sendData(JSON.stringify({ action: "download", user_id: userId, mod: modName }));
        window.location.href = `https://твойсервер.com/exe/${modName}`; // Replace with your server URL
    }

    // Initial auth check
    if (userId) {
        console.log(`Проверка авторизации для userId=${userId}`);
        tg.sendData(JSON.stringify({ action: "check_auth", user_id: userId }));
    } else {
        showAuth();
        showMessage("Ошибка: не удалось получить Telegram ID!", true);
    }
</script>
